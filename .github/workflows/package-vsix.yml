# ============================================================
# 工作流名称：Package VSIX
# 功能说明：自动编译、检查并打包 VS Code 扩展为 .vsix 安装包
# ============================================================
name: Package VSIX

on:
  # 推送触发：当 main 或 dev 分支的 TypeScript 源码发生变更时触发
  push:
    branches: [ main, dev ]
    paths:
      - 'src/**/*.ts'
  # 拉取请求触发：当向 main 或 dev 分支发起 PR 时触发
  pull_request:
    branches: [ main, dev ]
  # 手动触发：允许从 GitHub Actions 界面手动运行此工作流
  workflow_dispatch:

jobs:
  package:
    runs-on: ubuntu-latest
    
    steps:
    # 步骤 1：检出代码仓库
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 步骤 2：配置 Node.js 18 环境，并启用 npm 缓存加速依赖安装
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    # 步骤 3：使用 npm ci 安装依赖（基于 package-lock.json 的确定性安装）
    - name: Install dependencies
      run: npm ci
      
    # 步骤 4：编译 TypeScript 源码为 JavaScript
    - name: Compile TypeScript
      run: npm run compile
      
    # 步骤 5：运行 ESLint 代码检查，确保代码质量
    - name: Lint code
      run: npm run lint
      
    # 步骤 6：使用 vsce 将扩展打包为 .vsix 文件
    - name: Package VSIX
      run: npm run package
      
    # 步骤 7：上传 .vsix 构建产物，保留 30 天
    - name: Upload VSIX artifact
      uses: actions/upload-artifact@v4
      with:
        name: vsix-package
        path: '*.vsix'
        retention-days: 30
        
    # 步骤 8：当推送的是版本标签（v*）时，自动创建 GitHub Release 并附带 .vsix 文件
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: '*.vsix'
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}